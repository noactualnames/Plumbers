unit mainWindow;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Data.DB,
  IdTCPConnection, IdTCPClient, IdHTTP, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, System.JSON,
  REST.Backend.ServiceTypes, REST.Client, REST.Backend.EndPoint,
  Data.Bind.Components, Data.Bind.ObjectScope,
  Vcl.Grids, Vcl.DBGrids, operatorEntry;

type
  TfmMainWindow = class(TForm)
    Panel1: TPanel;
    btnAddOrder: TButton;
    btnExit: TButton;
    DBGrid2: TDBGrid;
    DBGrid1: TDBGrid;
    DBGrid3: TDBGrid;
    Timer1: TTimer;
    procedure btnAddOrderClick(Sender: TObject);
    procedure btnExitClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure DBGrid2CellClick(Column: TColumn);
    procedure DBGrid1TitleClick(Column: TColumn);
    procedure Timer1Timer(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  fmMainWindow: TfmMainWindow;
  curID: integer;

implementation

{$R *.dfm}

uses orderInfo, dm;

procedure TfmMainWindow.Timer1Timer(Sender: TObject);
  var login, password, plumberStatus, plumberName, s:string;
      responseJSON : TJSONObject;
      plumbers, orders, ordersinfo, plumbersArrayData:TJSONValue;
      plumbersArray:TJSONArray;
      i:integer;
      plumberId:integer;
      JSONBytes:string;
      url:string;
      response:string;

      begin
        login:=TOperatorEntry.eLogin.Text;
        password:=TOperatorEntry.ePassword.Text;

        dm.DataModule1.BackendEndpoint1.AddParameter('task','auth');
        dm.DataModule1.BackendEndpoint1.AddParameter('mode','1');
        dm.DataModule1.BackendEndpoint1.AddParameter('login', login);
        dm.DataModule1.BackendEndpoint1.AddParameter('password',password);
        dm.DataModule1.BackendEndpoint1.Execute;
        s:=dm.DataModule1.RESTResponseGet.Content;

        if (s.Length>45) then  begin
          responseJSON:=TJSONObject.ParseJSONValue(s) as TJSONObject;
          TOperatorEntry.opID:=responseJSON.GetValue<integer>('ID');

          TOperatorEntry.Hide;
          fmMainWindow:=TfmMainWindow.Create(Application);
          fmMainWindow.ShowModal;
          fmMainWindow.Release;
        end;
end;


procedure TfmMainWindow.btnAddOrderClick(Sender: TObject);
begin
 TOrderInfo:=TTOrderInfo.Create(Application);
 TOrderInfo.ShowModal;
 TOrderInfo.Release;
end;




procedure TfmMainWindow.btnExitClick(Sender: TObject);
begin
    fmMainWindow.Close;
    TOperatorEntry.Show;
end;

procedure TfmMainWindow.DBGrid2CellClick(Column: TColumn);
begin
    curID := dm.DataModule1.dsetOrders.FieldByName('ORDER_ID').Value;
end;

//sort
procedure TfmMainWindow.DBGrid1TitleClick(Column: TColumn);
begin
  Column.Field.DataSet.FieldByName('ORDER_INFO_ID');
end;

procedure TfmMainWindow.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  fmMainWindow.Close;
  TOperatorEntry.Show;
end;



end.
